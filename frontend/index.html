<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIMS </title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>AIMS </h1>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." class="search-input">
      <button onclick="searchProducts()" class="search-btn">
        <span class="search-icon">üîç</span>
        T√¨m ki·∫øm
      </button>
      <button onclick="clearSearch()" class="clear-search-btn" id="clearSearchBtn" style="display: none;">
        <span class="clear-icon">‚úï</span>
        X√≥a t√¨m ki·∫øm
      </button>
    </div>
    <div class="filter-container">
      <div class="filter-group">
        <label for="priceSort">L·ªçc theo gi√°:</label>
        <select id="priceSort" onchange="productManager.sortByPrice()">
          <option value="">-- Ch·ªçn s·∫Øp x·∫øp --</option>
          <option value="asc">Gi√° tƒÉng d·∫ßn</option>
          <option value="desc">Gi√° gi·∫£m d·∫ßn</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="titleSort">L·ªçc theo ti√™u ƒë·ªÅ:</label>
        <select id="titleSort" onchange="productManager.sortByTitle()">
          <option value="">-- Ch·ªçn s·∫Øp x·∫øp --</option>
          <option value="asc">A-Z</option>
          <option value="desc">Z-A</option>
        </select>
      </div>
      <div class="admin-actions" id="adminActions" style="display: none;">
        <button class="btn-add-product" onclick="productManager.showAddProductForm()">
          <span class="btn-icon">‚ûï</span>
          Th√™m s·∫£n ph·∫©m
        </button>
      </div>
    </div>
    <div class="auth-buttons" id="authButtons">
      <button onclick="location.href='login.html'">ƒêƒÉng nh·∫≠p</button>
      <button onclick="location.href='register.html'">ƒêƒÉng k√Ω</button>
    </div>
    <div class="user-info hidden" id="userInfo">
      <button class="btn-cart-view relative" id="viewCartBtn" onclick="location.href='cart.html'" tabindex="0" aria-label="Xem gi·ªè h√†ng" role="button" onkeydown="if(event.key==='Enter'){location.href='cart.html'}">
        <span class="cart-icon" style="font-size: 1.3em;">üõí</span>
        <span>Gi·ªè h√†ng</span>
        <span id="cartCountBadge" class="cart-badge" style="position:absolute;top:-8px;right:-8px;min-width:22px;height:22px;background:#ef4444;color:#fff;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:0.95em;font-weight:bold;box-shadow:0 1px 4px #0002;">3</span>
      </button>
      <button class="user-name-btn" id="userNameBtn" onclick="showUserProfile()">
        <span id="userName">T√™n ng∆∞·ªùi d√πng</span>
      </button>
      <button class="btn-logout" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    </div>
  </header>

  <main>
    <div class="search-results" id="searchResults" style="display: none;">
      <h3>K·∫øt qu·∫£ t√¨m ki·∫øm cho: "<span id="searchTerm"></span>"</h3>
      <p>T√¨m th·∫•y <span id="resultCount">0</span> s·∫£n ph·∫©m</p>
    </div>
    <div class="sort-results" id="sortInfo" style="display: none;">
      <!-- Th√¥ng tin s·∫Øp x·∫øp s·∫Ω ƒë∆∞·ª£c load t·ª´ JS -->
    </div>
    <div class="product-grid" id="productGrid">
      <!-- S·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c render t·ª´ JS -->
    </div>
  </main>

  <!-- User Profile Modal -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Th√¥ng tin ng∆∞·ªùi d√πng</h2>
        <span class="close" onclick="closeUserModal()">&times;</span>
      </div>
      <div id="userModalContent">
        <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load t·ª´ JS -->
      </div>
    </div>
  </div>

  <!-- Product  Modal -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Th√¥ng tin s·∫£n ph·∫©m</h2>
        <span class="close" onclick="closeProductModal()">&times;</span>
      </div>
      <div id="productModalContent">
        <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load t·ª´ JS -->
      </div>
    </div>
  </div>

  <script src="js/auth.js"></script>
  <script src="js/product.js"></script>
  <script>
    let currentSearchTerm = '';
    let isSearching = false;

    // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p v√† load s·∫£n ph·∫©m khi trang load
    document.addEventListener("DOMContentLoaded", async () => {
      await checkAuthStatus();
      await productManager.loadProducts();
      productManager.updateAdminUI(); // C·∫≠p nh·∫≠t UI admin
      
      // Th√™m event listener cho Enter key trong search input
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchProducts();
        }
      });
    });

    // ƒê√≥ng modal
    function closeUserModal() {
      const modal = document.getElementById('userModal');
      modal.style.display = 'none';
    }

    // ƒê√≥ng modal khi click b√™n ngo√†i
    window.onclick = function(event) {
      const modal = document.getElementById('userModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    }

    // T√¨m ki·∫øm s·∫£n ph·∫©m
    async function searchProducts() {
      await productManager.searchProducts();
    }

    // X√≥a t√¨m ki·∫øm v√† quay l·∫°i t·∫•t c·∫£ s·∫£n ph·∫©m
    async function clearSearch() {
      await productManager.clearSearch();
    }

    // Load s·∫£n ph·∫©m
    async function loadProducts() {
      await productManager.loadProducts();
    }

    // Function ƒë·ªÉ th√™m v√†o gi·ªè h√†ng tr·ª±c ti·∫øp (kh√¥ng qua modal)
    window.addToCartDirect = async function(productId) {
      const quantity = prompt('Nh·∫≠p s·ªë l∆∞·ª£ng:', '1');
      if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
        const result = await window.authManager.addToCart(productId, parseInt(quantity));
        
        if (result.success) {
          alert('ƒê√£ th√™m v√†o gi·ªè h√†ng th√†nh c√¥ng!');
        } else {
          alert(`L·ªói: ${result.error}`);
        }
      } else if (quantity !== null) {
        alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá!');
      }
    };

    // Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong gi·ªè h√†ng tr√™n badge
    async function updateCartBadge() {
      if (!window.authManager || !window.authManager.getCart) return;
      try {
        const result = await window.authManager.getCart();
        const badge = document.getElementById('cartCountBadge');
        if (badge) {
          if (result.success && result.data && result.data.items && result.data.items.length > 0) {
            let totalCount = 0;
            result.data.items.forEach(item => { totalCount += item.quantity; });
            badge.textContent = totalCount;
            badge.style.display = 'inline-flex';
          } else {
            badge.textContent = '0';
            badge.style.display = 'inline-flex';
          }
        }
      } catch (e) {}
    }
    document.addEventListener('DOMContentLoaded', updateCartBadge);
    // N·∫øu c√≥ thao t√°c th√™m v√†o gi·ªè h√†ng, g·ªçi updateCartBadge() l·∫°i ·ªü c√°c n∆°i ph√π h·ª£p
  </script>
</body>
</html>
